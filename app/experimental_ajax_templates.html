<!DOCTYPE html>
<html>
	<head>
	<title>FeedMe! by Hungry Bunch</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Stylesheets -->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />
	<link rel="stylesheet" type="text/css" href="styles/styles.css" />
	  
	<!-- Scripts -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!-- JQuery Mobile configuration, needs to be here before including jquery mobile script -->
	<script type="text/javascript">
		$(document).bind("mobileinit", function () {
		    $.mobile.ajaxEnabled = false;
		    $.mobile.linkBindingEnabled = false;
		    $.mobile.hashListeningEnabled = false;
		    $.mobile.pushStateEnabled = false;

		    // Remove page from DOM when it's being replaced
		    $('div[data-role="page"]').live('pagehide', function (event, ui) {
		        $(event.currentTarget).remove();
		    });
		});
	</script>
	<script type="text/javascript" src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
    <script type="text/javascript" src="scripts/lib/underscore.js"></script>
    
    <script type="text/javascript" src="scripts/lib/handlebars-1.0.0.beta.6.js"></script>

    <script type="text/javascript" src="scripts/lib/json2.js"></script>
    <script type="text/javascript" src="scripts/lib/backbone.js"></script>
    <script type="text/javascript" src="scripts/lib/backbone.localStorage.js"></script>

    <script type="text/javascript" src="scripts/experimental_mvc.js"></script>
	<script type="text/javascript" src="scripts/scripts.js"></script>
	<script type="text/javascript" src="scripts/lscache.js"></script>

	<script>
		//(function() {

			var AppData = {
				restaurants : null,
				templates : {
					restaurants : null,
					menu : null,
					footer : null
				},
				events : {
					EVENT_TEMPLATES_LOADED : 'applicationTemplatesLoaded'
				}
			};
			var app;

			function setDataToLocalStorage() {
				var restaurantsTestData = {
					1: { id : 1, name : 'Taffa', menu : [
						{ day: 'monday',  meal: ['Meal A for #1', 'Meal B for #1']}, 
						{day:'tuesday', meal: ['Tuesday meal']}
						]},
					2: { id : 2, name : 'Teekkariravintolat', menu : [{ day: 'monday', meal : ['Meal A for #2', 'Meal B for #2']}]},
					3: { id : 3, name : 'Kvarkki', menu : [{ day: 'monday', meal : ['Meal A for #3', 'Meal B for #3']}]},
					4: { id : 4, name : 'Cantina', menu : [{ day : 'monday', meal : ['Meal A for #4', 'Meal B for #4']}]},
					5: { id : 5, name : 'TUAS', menu : [{ day : 'monday', meal : ['Meal A for #5', 'Meal B for #5']}]}
				}
				// Set test data to local storage
				localStorage.setItem("RestaurantsTestBySami", JSON.stringify(restaurantsTestData));
			}
			setDataToLocalStorage();

			var fixgeometry = function() {
			  scroll(0, 0);

			  /* Calculate the geometry that our content area should take */
			  var header = $(".header:visible");
			  var footer = $(".footer:visible");
			  var content = $(".content:visible");
			  var viewport_height = $(window).height();
			  
			  var content_height = viewport_height - header.outerHeight() - footer.outerHeight();
			  
			  /* Trim margin/border/padding height */
			  content_height -= (content.outerHeight() - content.height());
			  content.height(content_height);
			}; /* fixgeometry */


			var updateTemplateStatus = function () {
				// Check if all template html is loaded
				for( item in AppData.templates ) {
					if( AppData.templates[item] == null ) {
						return false;
					}
				}
				// All ok
				$(document).trigger(AppData.events.EVENT_TEMPLATES_LOADED);
			}

			var loadTemplates = function () {
				$.get('templates/restaurants.html', function(data) {
					AppData.templates.restaurants = data;
					updateTemplateStatus();
				});
				$.get('templates/menu.html', function(data) {
					AppData.templates.menu = data;	
					updateTemplateStatus();
				});
				$.get('templates/footer.html', function(data) {
					AppData.templates.footer = data;
					updateTemplateStatus();
				});
			}

			function startApplication() {
				// Compile templates to view
				window.RestaurantsView.template = Handlebars.compile(AppData.templates.restaurants + AppData.templates.footer);
				window.MenuView.template = Handlebars.compile(AppData.templates.menu + AppData.templates.footer);
			   
			    //Instantiate the collection of restaurants
				AppData.restaurants = new RestaurantsCollection();
				AppData.restaurants.fetch();

				// Create routing
			    app = new AppRouter();
			    Backbone.history.start();

			    console.log('Started application');
			}

			$(document).ready(function () {
				//$(window).bind("orientationchange resize pageshow", fixgeometry);
				
				// Start application when templates are loaded
				$(document).on(AppData.events.EVENT_TEMPLATES_LOADED, startApplication);

				// Load templates
				loadTemplates();
			});

		//})();
	</script>

</head>
<body>

</body>
</html>