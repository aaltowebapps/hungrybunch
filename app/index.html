<!DOCTYPE html>
<html>
	<head>
	<title>FeedMe! by Hungry Bunch</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Stylesheets -->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
	<link rel="stylesheet" type="text/css" href="styles/styles.css" />
	<!-- Scripts -->
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script>
    <script type="text/javascript" src="scripts/lib/handlebars-1.0.0.beta.6.js"></script>
    <script type="text/javascript" src="scripts/lib/underscore.js"></script>
    <script type="text/javascript" src="scripts/lib/json2.js"></script>
    <script type="text/javascript" src="scripts/lib/backbone.js"></script>
    <script type="text/javascript" src="scripts/lib/backbone.localStorage.js"></script>
	<script type="text/javascript" src="scripts/scripts.js"></script>
	<script type="text/javascript" src="scripts/lib/lscache.js"></script>
	<script>
		$(document).ready(function () {
			init();
		});
	</script>

	<!--<script id='restaurants' type='text/x-handlebars-template' src="templates/menu.html">-->
	<script id='restaurants' type='text/x-handlebars-template'>		
		{{#each this}}
			<!-- check if the restaurants[index].campus is Otaniemi -->
			{{#isOtaniemi}}	
				<ul data-role="listview" data-inset="true" class="ui-listview">
				<li data-role="list-divider" role="heading" style="background:#56A00E;">{{name}}</li>
				{{#menu}}
					{{#monday}}
						<li data-role="list-divider" role="heading">Monday</li>
						{{#each meal}}
							<li role="heading" data-theme="c" class="ui-li ui-li-static ui-body-c">{{this}}</li>
						{{/each}}
					{{/monday}}
					
					{{#tuesday}}
						<li data-role="list-divider" role="heading">Tuesday</li>
						{{#each meal}}
							<li role="heading" data-theme="c" class="ui-li ui-li-static ui-body-c">{{this}}</li>
						{{/each}}
					{{/tuesday}}
					
					{{#wednesday}}
						<li data-role="list-divider" role="heading">Wednesday</li>
						{{#each meal}}
							<li role="heading" data-theme="c" class="ui-li ui-li-static ui-body-c">{{this}}</li>
						{{/each}}
					{{/wednesday}}
					
					{{#thursday}}
						<li data-role="list-divider" role="heading">Thursday</li>
						{{#each meal}}
							<li role="heading" data-theme="c" class="ui-li ui-li-static ui-body-c">{{this}}</li>
						{{/each}}
					{{/thursday}}
					
					{{#friday}}
						<li data-role="list-divider" role="heading">Friday</li>
						{{#each meal}}
							<li role="heading" data-theme="c" class="ui-li ui-li-static ui-body-c">{{this}}</li>
						{{/each}}
					{{/friday}}
					
					{{#saturday}}
						<li data-role="list-divider" role="heading">Saturday</li>
						{{#each meal}}
							<li role="heading" data-theme="c" class="ui-li ui-li-static ui-body-c">{{this}}</li>
						{{/each}}
					{{/saturday}}
					
					{{#sunday}}
						<li data-role="list-divider" role="heading">Sunday</li>
						{{#each meal}}
							<li role="heading" data-theme="c" class="ui-li ui-li-static ui-body-c">{{this}}</li>
						{{/each}}
					{{/sunday}}						
				{{/menu}}
				</ul>
			{{/isOtaniemi}}
		{{/each}}		
	</script>

	<script>

		// Placeholder for templates
		var Templates = {};

			var restaurants, days;

		// Models
		var Day = Backbone.Model.extend ({
		  name : '',
		  menus : []
		});

		// Models
		var Restaurant = Backbone.Model.extend ({
		  name : '',
		  menus : []
		});
		// Collections		
		var Days  = Backbone.Collection.extend ({
		  model: Day,
		});
		var Restaurants = Backbone.Collection.extend ({
		  model: Restaurant,
		  localStorage: new Backbone.LocalStorage("Restaurants")
		});

		var fixgeometry = function() {
		  scroll(0, 0);
		  
		  /* Calculate the geometry that our content area should take */
		  var header = $(".header:visible");
		  var footer = $(".footer:visible");
		  var content = $(".content:visible");
		  var viewport_height = $(window).height();
		  
		  var content_height = viewport_height - header.outerHeight() - footer.outerHeight();
		  
		  /* Trim margin/border/padding height */
		  content_height -= (content.outerHeight() - content.height());
		  content.height(content_height);
		}; /* fixgeometry */

		function loadMenu() {
			var content = Templates.restaurants(restaurants);
			$("#menus").html(content).find("ul").listview();
		}
		
		$(document).ready(function () {
			$(window).bind("orientationchange resize pageshow", fixgeometry);

			// Template helpers
			Handlebars.registerHelper('isOtaniemi', function(block) {
				if(this.campus == "Otaniemi") {
					return block(this);
				} else {
					return block.inverse(this);
				}
			});
  
			// Compile templates
 	        $('script[type="text/x-handlebars-template"]').each(function () {
				Templates[this.id] = Handlebars.compile($(this).html());
            });
	
			loadMenu();
		});

  			// View for rendering a day's meals
	        var DayView = Backbone.View.extend ({
	            tagName: "li",
	            events: {
	              // Johannes: had to comment this to get rid of errors.
	              //"click a.start" : "setStartTime",
				},
	            initialize: function() { 
	              this.model.bind('change', this.render, this);
	              this.template = Templates.restaurants;  
	            },
	            render: function() { 
	              $(this.el).html( this.template(this.model.toJSON()) ); 
	              return this; 
	            }
			});

  			//View for rendering one restaurant in a list of restaurants
	        var RestaurantView = Backbone.View.extend ({
	            tagName: "li",
	            events: {
	              // Johannes: had to comment this to get rid of errors.
	              //"click a.start" : "setStartTime",
				},
	            initialize: function() { 
	              // Johannes: I had to comment this to get rid of error.
	              //this.model.bind('change', this.render, this);
	              this.template = Templates.restaurants;  
	            },
	            render: function() { 
	              $(this.el).html( this.template(this.model.toJSON()) ); 
	              return this; 
	            }
			});

	        //View for rendering the list of entries
	        var DaysListView = Backbone.View.extend ({
	            el: $("#daysList"),
	            events: {
	            },
	            initialize: function() {
	              this.collection.bind('reset', this.render, this);
	              this.collection.bind('all', this.render, this);
	            },
	            render: function() {
	              var el = this.$el;
	              el.empty();
	              this.collection.each(function(item) {
	                var itemView = new DayView({model: day});
	                el.append(itemView.render().el);
	              });
	              this.$el.listview('refresh');
	              return this;
	            }
          	});


	        //View for rendering the list of entries
	        var RestaurantsListView = Backbone.View.extend ({
	            el: $("#restaurantsList"),
	            events: {
	            },
	            initialize: function() {
	              this.collection.bind('reset', this.render, this);
	              this.collection.bind('all', this.render, this);
	            },
	            render: function() {
	              var el = this.$el;
	              el.empty();
	              this.collection.each(function(item) {
	                var itemView = new RestaurantView({model: restaurant});
	                el.append(itemView.render().el);
	              });
	              this.$el.listview('refresh');
	              return this;
	            }
          	});

			days = new Days();
			restaurants = new Restaurants();

	    	//Instantiate the views
	    	var daysView = new RestaurantView({collection: restaurants});
	    	var restaurantsView = new RestaurantView({collection: restaurants});
      

	  </script>
</head>
<body>
	<div data-role="page">
		<div class="header" data-role="header">
			<h1>FeedMe!</h1>
		</div><!-- /header -->
		<div class='content' data-role='content' id="menus"> </div> 
		
		<div class="footer" data-role="footer">		
			<div data-role="navbar">
				<ul>
					<li><a href="#">Favorites</a></li>
					<li><a href="#">Menus</a></li>
					<li><a href="#" class="ui-btn-active">Restaurants</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /footer -->
	</div><!-- /page -->
</body>
</html>